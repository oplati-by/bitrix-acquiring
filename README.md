# oplati.paysystem
Модуль для интеграции платежной системы Оплати для коробочных решений магазинов на Битрик

## Установка
Необходимо разместить папку с модулем [oplati.paysystem](oplati.paysystem) в директорию local/modules или bitrix/modules, после чего произвести установку из списка "Установленных решений".
НЕЛЬЗЯ РАЗМЕЩАТЬ МОДУЛЬ В НЕСКОЛЬКИХ МЕСТАХ ОДНОВРЕМЕННО.

После установки модуля будет создана директория /local/php_interface/include/sale_payment/oplati, в которой будет размещен обработчик платежной системы.

## Логирование
Логи храняться в папке /local/php_interface/include/sale_payment/oplati/ в соответствующих файлах с названиям соответстующими  oplati-date('d-m-Y-H')-log.json
В эту папку при включении логирования запросов в настройках модуля будут записываться файлы логов запросов.

### Настройки модуля
В настройках модулей Битриска находим модуль "Оплати". Для работы обязательно необходимо указать:
- Какой контур использовать
- Регистрационный номер кассы
- Пароль
- Cекретный ключ интернет-кассы
- Каким образом вызываем оплату

В случае с возникновением проблем с обратной совместимостью при формировании запросов можно переключить настройку "Какой метод используем для отправки запросов" c дефолтного значения "Вitrix HttpClient" на более старую версию "Curl"

Если необходимо отправлять ежедневную сверку по платежам, то необходимо включить настройку "Cверять итоги по смене с платежной системой "Оплати"(каждый день после 00:01)" и указать список email для рассылки в поле "Список почтовых ящиков для отправки уведомления об ошибке сверки с онлайн кассой (через запятую)".

### Регистрируемые агенты
При установке модуля создается агент Oplati\Paysystem\Handlers\BackgroundJobHandlers::SyncPaymentAgent(); c интервалом вызова 120сек для сверки платежей по платежной системе Оплати без информации о статусе оплаты.
При включении ежедневной сверке по платежам регистрируется агент Oplati\Paysystem\Handlers\BackgroundJobHandlers::PaymentReconciliationAgent();	c интервалом 86400сек (1 сутки) c запусков в 00:01:00.

### Регистрируемые события
При установки модуля в системе регистрируется почтовое событие (CEventType) с именем OPLATI_RECONCILIATION и соответствующий ему почтовый шаблон (CEventMessage) для рассылки данных о сверке 